# å¢å¼ºèåˆæ–¹æ³•ï¼šStructure Anchor + Detail Overlay

## ğŸ¯ é—®é¢˜åˆ†æ

### åŸå§‹é—®é¢˜
- ç½®ä¿¡åº¦ä¸ç¨³å®šï¼Œæ— æ³•è¾¾åˆ°60%+
- Marginå€¼è¿‡å°ï¼Œæ— æ³•è¾¾åˆ°20%+
- èåˆæ–¹æ³•å¯¹ä¸¤ä¸ªä¸åŒç²’åº¦çš„æ•°æ®æºå¤„ç†ä¸å½“

### æ ¹æœ¬åŸå› 
1. **æ•°æ®æºä¸åŒ¹é…**
   - Structure: `Sense_A_Finetuned.fixed.jsonl` (æ‹“æ‰‘è¯­ä¹‰)
   - Detail: `Sense_A_MS.jsonl` (ç”¨æˆ·ç…§ç‰‡åºåˆ—)

2. **èåˆé€»è¾‘ç¼ºé™·**
   - ç¼ºå°‘æ­£ç¡®çš„æ•°æ®å¯¹é½æœºåˆ¶
   - æƒé‡è®¾ç½®ä¸åˆç†
   - è¯„åˆ†æ ‡å‡†ä¸ä¸€è‡´

## ğŸ—ï¸ æ”¹è¿›çš„èåˆæ¶æ„

### 1. æ•°æ®å¯¹é½ç­–ç•¥
```python
# ä½¿ç”¨node_hintå­—æ®µè¿›è¡Œæ•°æ®å¯¹é½
def find_node_details_by_hint(node_id: str, detailed_data: list):
    """ä»Sense_A_MS.jsonlä¸­æŸ¥æ‰¾ä¸structureèŠ‚ç‚¹å…³è”çš„detailæè¿°"""
    for item in detailed_data:
        if item.get("node_hint") == node_id:  # å…³é”®ï¼šä½¿ç”¨node_hintå­—æ®µ
            node_details.append(item)
```

### 2. åˆ†å±‚èåˆæµç¨‹
```
Phase 1: Structure Anchor (Sense_A_Finetuned.fixed.jsonl)
â”œâ”€â”€ ä¸»è¦èŠ‚ç‚¹çº§åŒ¹é…
â”œâ”€â”€ ç”ŸæˆåŸºç¡€ç½®ä¿¡åº¦ (0.6-0.9)
â””â”€â”€ ä¿è¯å®šä½ç¨³å®šæ€§

Phase 2: Detail Overlay (Sense_A_MS.jsonl)
â”œâ”€â”€ åŸºäºnode_hintçš„æ•°æ®å¯¹é½
â”œâ”€â”€ å¤šç»´åº¦è¯­ä¹‰å¢å¼º
â””â”€â”€ ä¿å®ˆçš„æƒé‡åˆ†é…
```

### 3. å¢å¼ºçš„è¯„åˆ†è®¡ç®—
```python
# å¤šç»´åº¦detailè¯„åˆ†
1. Natural Language Text (40% weight)
   - è¯­ä¹‰ç›¸ä¼¼åº¦ (SentenceTransformer)
   - åŸºäºstructure scoreçš„åŠ¨æ€ç¼©æ”¾

2. Structured Text (20% weight)
   - ç»“æ„åŒ–æ–‡æœ¬åŒ¹é…
   - å…³é”®è¯å’Œå±æ€§åŒ¹é…

3. Spatial Relations (15% weight)
   - ç©ºé—´å…³ç³»åŒ¹é…
   - æ–¹å‘æ€§ä¿¡æ¯

4. Unique Features (10% weight)
   - ç‹¬ç‰¹ç‰¹å¾è¯†åˆ«
   - ç¯å¢ƒç‰¹å®šå…ƒç´ 
```

## ğŸ”§ æŠ€æœ¯å®ç°

### 1. ç½®ä¿¡åº¦è®¡ç®—å…¬å¼
```python
# æ”¹è¿›çš„èåˆå…¬å¼
C_total = C_structure + Î²Â·C_detail

# å…¶ä¸­ï¼š
# - C_structure: ç»“æ„é€šé“åŸºç¡€åˆ†æ•° (0.6-0.9)
# - C_detail: ç»†èŠ‚é€šé“å¢å¼ºåˆ†æ•° (0.0-0.4)
# - Î²: å¢å¼ºæƒé‡ç³»æ•° (0.15ï¼Œä¿å®ˆè®¾ç½®)
# - æœ€å¤§å¢å¼º: 0.4åˆ† (é¿å…è¿‡åº¦å¢å¼º)
```

### 2. åŠ¨æ€æƒé‡è°ƒæ•´
```python
# åŸºäºstructure scoreçš„åŠ¨æ€ç¼©æ”¾
if structure_score > 0.8:
    detail_weight = 0.8  # é«˜ç½®ä¿¡åº¦ = ä¿å®ˆå¢å¼º
elif structure_score > 0.6:
    detail_weight = 0.9  # ä¸­ç­‰ç½®ä¿¡åº¦ = é€‚åº¦å¢å¼º
else:
    detail_weight = 1.0  # ä½ç½®ä¿¡åº¦ = ç§¯æå¢å¼º
```

### 3. é˜ˆå€¼ä¼˜åŒ–
```python
# ç›®æ ‡ï¼šç¨³å®š60%+ç½®ä¿¡åº¦ï¼Œ20%+ margin
LOWCONF_SCORE_TH = 0.60    # ç½®ä¿¡åº¦é˜ˆå€¼
LOWCONF_MARGIN_TH = 0.20   # Marginé˜ˆå€¼
```

## ğŸ“Š æ•°æ®æµåˆ†æ

### 1. Structure Channel (Sense_A_Finetuned.fixed.jsonl)
- **å†…å®¹**: å®Œæ•´çš„æ‹“æ‰‘ç»“æ„ã€èŠ‚ç‚¹å®šä¹‰ã€ç©ºé—´å…³ç³»
- **ç‰¹ç‚¹**: é«˜è¯­ä¹‰å¯†åº¦ï¼Œç»“æ„åŒ–ç¨‹åº¦é«˜
- **ä½œç”¨**: æä¾›ç¨³å®šçš„å®šä½åŸºç¡€

### 2. Detail Channel (Sense_A_MS.jsonl)
- **å†…å®¹**: ç”¨æˆ·æ‹æ‘„çš„ç…§ç‰‡åºåˆ—ã€è§†è§‰æè¿°ã€ç©ºé—´å…³ç³»
- **ç‰¹ç‚¹**: é«˜è§†è§‰ç»†èŠ‚ï¼Œç”¨æˆ·è§†è§’
- **ä½œç”¨**: æä¾›è¯­ä¹‰å¢å¼ºå’Œç”¨æˆ·ç†è§£

### 3. æ•°æ®å¯¹é½æœºåˆ¶
```json
{
  "id": "SCENE_A_MS_IMG_0107",
  "node_hint": "dp_ms_entrance",  // å…³é”®ï¼šæŒ‡å‘structureèŠ‚ç‚¹
  "nl_text": "View near dp ms entrance...",
  "spatial_relations": {"front": "yellow floor line", "left": "QR shelf..."},
  "unique_features": ["", "", "QR shelf", "drawer wall", "", "", "", "", "", "", ""]
}
```

## ğŸ¯ é¢„æœŸæ•ˆæœ

### 1. ç½®ä¿¡åº¦ç¨³å®šæ€§
- **ç›®æ ‡**: ç¨³å®šåœ¨60%+èŒƒå›´
- **æœºåˆ¶**: Structureä¸»å¯¼ + Detailä¿å®ˆå¢å¼º
- **ä¼˜åŠ¿**: é¿å…è¿‡åº¦å¢å¼ºå¯¼è‡´çš„ç½®ä¿¡åº¦æ³¢åŠ¨

### 2. Marginæå‡
- **ç›®æ ‡**: ç¨³å®šåœ¨20%+èŒƒå›´
- **æœºåˆ¶**: å¤šç»´åº¦è¯„åˆ† + æƒé‡å¹³è¡¡
- **ä¼˜åŠ¿**: æé«˜ç»“æœåŒºåˆ†åº¦å’Œå¯é æ€§

### 3. ç”¨æˆ·ä½“éªŒæ”¹å–„
- **å®šä½å‡†ç¡®æ€§**: åŸºäºç¨³å®šçš„structure anchor
- **è¯­ä¹‰ä¸°å¯Œæ€§**: é€šè¿‡detail overlayæä¾›ç¯å¢ƒç»†èŠ‚
- **ç³»ç»Ÿé²æ£’æ€§**: é™çº§æœºåˆ¶ä¿è¯æœåŠ¡è¿ç»­æ€§

## ğŸ” ç›‘æ§å’Œè°ƒä¼˜

### 1. å…³é”®æŒ‡æ ‡
- Structureç½®ä¿¡åº¦åˆ†å¸ƒ
- Detailå¢å¼ºæ•ˆæœ
- èåˆåç½®ä¿¡åº¦ç¨³å®šæ€§
- Marginå€¼åˆ†å¸ƒ

### 2. è°ƒä¼˜å‚æ•°
```python
# å¯è°ƒæ•´çš„å‚æ•°
beta = 0.15              # Detailå¢å¼ºæƒé‡
detail_cap = 0.4         # Detailåˆ†æ•°ä¸Šé™
spatial_weight = 0.15    # ç©ºé—´å…³ç³»æƒé‡
feature_weight = 0.1     # ç‰¹å¾æƒé‡
```

### 3. æ€§èƒ½ç›‘æ§
- è¯­ä¹‰ç›¸ä¼¼åº¦è®¡ç®—æ—¶é—´
- æ•°æ®å¯¹é½æˆåŠŸç‡
- èåˆè®¡ç®—å¼€é”€

## ğŸš€ ä½¿ç”¨åœºæ™¯

### 1. æ ‡å‡†æ£€ç´¢
```
ç”¨æˆ·æ‹ç…§ â†’ Structureå®šä½ â†’ Detailå¯¹é½ â†’ è¯­ä¹‰å¢å¼º â†’ å¯¼èˆªæŒ‡å¯¼
```

### 2. é«˜ç½®ä¿¡åº¦åœºæ™¯
```
Structureåˆ†æ•° > 0.8 â†’ ä¿å®ˆDetailå¢å¼º â†’ ç¨³å®šé«˜ç½®ä¿¡åº¦
```

### 3. ä½ç½®ä¿¡åº¦åœºæ™¯
```
Structureåˆ†æ•° < 0.6 â†’ ç§¯æDetailå¢å¼º â†’ æå‡å®šä½è´¨é‡
```

## ğŸ“ é…ç½®å»ºè®®

### 1. ç”Ÿäº§ç¯å¢ƒ
```python
# ä¿å®ˆè®¾ç½®ï¼Œä¿è¯ç¨³å®šæ€§
beta = 0.15
detail_cap = 0.4
LOWCONF_SCORE_TH = 0.60
LOWCONF_MARGIN_TH = 0.20
```

### 2. å¼€å‘ç¯å¢ƒ
```python
# æ¿€è¿›è®¾ç½®ï¼Œæµ‹è¯•å¢å¼ºæ•ˆæœ
beta = 0.25
detail_cap = 0.5
LOWCONF_SCORE_TH = 0.50
LOWCONF_MARGIN_TH = 0.15
```

## ğŸ‰ æ€»ç»“

æ”¹è¿›çš„èåˆæ–¹æ³•é€šè¿‡ä»¥ä¸‹ç­–ç•¥è§£å†³äº†åŸå§‹é—®é¢˜ï¼š

1. **æ­£ç¡®çš„æ•°æ®å¯¹é½**: ä½¿ç”¨`node_hint`å­—æ®µå…³è”ä¸¤ä¸ªæ•°æ®æº
2. **ä¿å®ˆçš„å¢å¼ºç­–ç•¥**: é¿å…Detailè¿‡åº¦å½±å“Structureçš„ç¨³å®šæ€§
3. **å¤šç»´åº¦è¯„åˆ†**: å……åˆ†åˆ©ç”¨Sense_A_MS.jsonlä¸­çš„ä¸°å¯Œä¿¡æ¯
4. **åŠ¨æ€æƒé‡è°ƒæ•´**: åŸºäºStructureè´¨é‡è°ƒæ•´Detailå¢å¼ºå¼ºåº¦

è¿™ç§æ–¹æ³•æ—¢ä¿æŒäº†Structureçš„é«˜ç½®ä¿¡åº¦ä¼˜åŠ¿ï¼Œåˆé€šè¿‡Detailæä¾›äº†ä¸°å¯Œçš„è¯­ä¹‰å¢å¼ºï¼Œæ˜¯ä¸€ä¸ªå¹³è¡¡ç¨³å®šæ€§å’Œå¢å¼ºæ•ˆæœçš„ä¼˜ç§€è§£å†³æ–¹æ¡ˆã€‚
